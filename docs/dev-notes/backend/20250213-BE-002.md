## 开发心得 - 2026-02-13

### 任务信息
- **任务编号**: BE-002
- **任务描述**: JWT Secret 安全修复 - 将硬编码的 JWT Secret 移至环境变量
- **耗时**: 1.5 小时
- **代码变更**: +104 行, -1 行

### 问题背景

在进行安全审查时，发现 `config.py` 中的 `JWT_SECRET_KEY` 使用了硬编码的默认值：

```python
JWT_SECRET_KEY: str = "your-secret-key-change-in-production"
```

这存在严重的安全风险：
1. 如果部署时忘记修改，会使用默认的弱密钥
2. 密钥一旦泄露，所有 JWT 令牌都可能被伪造
3. 不符合安全最佳实践

### 解决方案

#### 1. 修改配置类 (config.py)

将 `JWT_SECRET_KEY` 的默认值移除，改为强制从环境变量读取：

```python
# 修改前
JWT_SECRET_KEY: str = "your-secret-key-change-in-production"

# 修改后
JWT_SECRET_KEY: str  # 必须在环境变量中设置，无默认值
```

这样，如果环境变量未设置，Pydantic 会在启动时抛出 `ValidationError`，强制开发者配置密钥。

#### 2. 更新 .env.example

添加了清晰的注释说明：

```bash
# Security - 必须设置！
JWT_SECRET_KEY=your-256-bit-secret-key-change-this-in-production-min-32-chars
```

#### 3. 创建安全测试

编写了 8 个测试用例验证修复：

| 测试用例 | 目的 |
|---------|------|
| `test_jwt_secret_key_from_env` | 验证从环境变量正确读取 |
| `test_jwt_secret_key_missing_raises_error` | 验证未设置时抛出错误 |
| `test_jwt_secret_key_minimum_length` | 验证密钥长度检查 |
| `test_create_and_decode_access_token` | 验证访问令牌创建和解码 |
| `test_create_and_decode_refresh_token` | 验证刷新令牌创建和解码 |
| `test_decode_expired_token` | 验证过期令牌处理 |
| `test_decode_invalid_token` | 验证无效令牌处理 |
| `test_token_type_mismatch` | 验证令牌类型检查 |

### 遇到的问题

#### 问题 1: Pydantic Settings 缓存导致测试失败
**现象**: 在测试中修改环境变量后，配置类仍然使用旧值
**原因**: `get_settings()` 使用了 `@lru_cache()` 缓存配置
**解决**: 在测试中使用 `Settings(_env_file=None)` 直接实例化，绕过缓存
**耗时**: 20 分钟

#### 问题 2: 模块导入路径问题
**现象**: 运行测试时出现 `ModuleNotFoundError: No module named 'ai_ppt'`
**原因**: pytest 不知道 `src` 目录是 Python 包根目录
**解决**: 在 `pyproject.toml` 中添加 `pythonpath = ["src"]`
**耗时**: 15 分钟

### 修改的文件清单

1. `src/ai_ppt/config.py` - 移除 JWT_SECRET_KEY 默认值
2. `.env.example` - 更新环境变量模板
3. `.env` - 更新开发环境配置
4. `pyproject.toml` - 添加 pytest pythonpath 配置
5. `tests/unit/test_config_security.py` - 新增安全测试

### 测试验证

```bash
$ JWT_SECRET_KEY=test-secret-key-for-unit-testing-only-32chars python -m pytest tests/unit/test_config_security.py -v

========================= 8 passed, 1 warning in 0.17s =========================
```

所有测试通过，验证：
- ✅ 配置正确从环境变量读取
- ✅ 未设置时抛出验证错误
- ✅ JWT 令牌创建/验证正常工作
- ✅ 错误处理逻辑正确

### 安全改进

| 检查项 | 修复前 | 修复后 |
|-------|-------|-------|
| 硬编码密钥 | ⚠️ 有默认值 | ✅ 无默认值，强制环境变量 |
| 启动检查 | ⚠️ 无 | ✅ 未设置时启动失败 |
| 文档说明 | ⚠️ 不完整 | ✅ 清晰标注"必须设置" |
| 测试覆盖 | ❌ 无 | ✅ 8 个测试用例 |

### 经验教训

1. **配置安全优先**: 敏感配置不应该有默认值，宁愿启动失败也不要带着弱密钥运行
2. **测试环境隔离**: 使用 `Settings(_env_file=None)` 可以确保测试不受 .env 文件影响
3. **安全即功能**: 安全修复也应该有完整的测试覆盖

### 对项目的建议

1. **密钥轮换机制**: 考虑实现 JWT 密钥轮换，支持平滑切换密钥
2. **密钥长度验证**: 可以添加自定义验证器确保密钥长度 ≥ 32 字符
3. **生产环境检查**: 添加中间件检查生产环境是否使用了默认/弱密钥

### 参考资料

- [OWASP JWT Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html)
- [PyJWT 文档](https://pyjwt.readthedocs.io/)
- [Pydantic Settings 文档](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
