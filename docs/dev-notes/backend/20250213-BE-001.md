## 开发心得 - 2026-02-13

### 任务信息
- **任务编号**: BE-001
- **任务描述**: 测试覆盖率提升 - 为 auth_service 编写单元测试
- **耗时**: 4 小时
- **代码变更**: +600 行, +2 个测试文件

### 测试范围

本次任务为 **认证服务 (auth_service)** 编写了完整的单元测试，包括：

| 模块 | 测试类 | 测试数量 | 覆盖率 |
|-----|-------|---------|-------|
| `core/security.py` | `TestPasswordSecurity`, `TestJWTToken` | 9 | 88% |
| `models/user.py` | `TestUserModel` | 2 | 100% |
| `api/v1/endpoints/auth.py` | `TestAuthEndpoints` | 13 | 98% |
| `api/deps.py` | `TestAuthDependencies` | 8 | 100% |
| `config.py` | `TestConfigSecurity` | 8 | 100% |

**总计**: 40 个测试用例，全部通过 ✅

### 测试结构

```
tests/unit/
├── test_auth_service.py      # Auth 服务测试 (32 个用例)
└── test_config_security.py   # 安全配置测试 (8 个用例)
```

### 核心测试场景

#### 1. 密码安全测试 (`TestPasswordSecurity`)

```python
def test_get_password_hash_generates_bcrypt_hash(self):
    """验证密码哈希生成使用 bcrypt 算法"""
    password = "my-secret-password"
    hashed = get_password_hash(password)
    
    assert hashed.startswith("$2b$")  # bcrypt 格式
def test_verify_password_with_correct_password(self):
    """验证正确密码可以验证通过"""
    assert verify_password(password, hashed) is True
def test_verify_password_with_wrong_password(self):
    """验证错误密码被拒绝"""
    assert verify_password(wrong_password, hashed) is False
```

#### 2. JWT 令牌测试 (`TestJWTToken`)

```python
def test_create_access_token_contains_user_id(self):
    """验证访问令牌包含正确的用户 ID"""
    token = create_access_token(user_id)
    decoded_id, error = decode_token(token, expected_type="access")
    assert decoded_id == user_id
def test_token_type_mismatch_access_vs_refresh(self):
    """验证访问令牌和刷新令牌的类型区分"""
    refresh_token = create_refresh_token(user_id)
    decoded_id, error = decode_token(refresh_token, expected_type="access")
    assert "type" in error.lower()
```

#### 3. API 端点测试 (`TestAuthEndpoints`)

覆盖所有认证端点：
- `POST /auth/register` - 注册成功/邮箱已存在/用户名已存在
- `POST /auth/login` - 登录成功/密码错误/用户不存在/用户被禁用
- `POST /auth/refresh` - 刷新成功/无效令牌/过期令牌/用户不存在/用户被禁用

使用 Mock 技术隔离数据库依赖：

```python
@pytest.fixture
def mock_db(self):
    """创建模拟的数据库会话"""
    return AsyncMock(spec=AsyncSession)

async def test_register_success(self, mock_db, sample_user):
    # 模拟数据库查询返回 None（用户不存在）
    mock_result = MagicMock()
    mock_result.scalar_one_or_none.return_value = None
    mock_db.execute.return_value = mock_result
    
    # 验证注册逻辑
    response = await register(request, mock_db)
    assert response.access_token is not None
```

#### 4. 依赖注入测试 (`TestAuthDependencies`)

测试 `get_current_user` 和 `get_optional_user`：

```python
async def test_get_current_user_no_credentials(self, mock_db):
    """测试缺少认证信息时返回 401"""
    with pytest.raises(HTTPException) as exc_info:
        await get_current_user(None, mock_db)
    assert exc_info.value.status_code == 401

async def test_get_current_user_expired_token(self, mock_db):
    """测试过期令牌返回 401"""
    expired_token = create_access_token(
        user_id, 
        expires_delta=timedelta(seconds=-1)
    )
    with pytest.raises(HTTPException) as exc_info:
        await get_current_user(credentials, mock_db)
    assert "TOKEN_EXPIRED" in str(exc_info.value.detail)
```

### 遇到的问题

#### 问题 1: 异步测试的依赖注入
**现象**: 测试 `get_current_user` 时无法正确注入 `HTTPAuthorizationCredentials`
**原因**: FastAPI 的依赖注入在测试环境中需要手动构造
**解决**: 使用 `HTTPAuthorizationCredentials` 直接构造凭证对象

```python
from fastapi.security import HTTPAuthorizationCredentials

credentials = HTTPAuthorizationCredentials(
    scheme="Bearer",
    credentials=token
)
```

#### 问题 2: SQLAlchemy 模型默认值问题
**现象**: `User` 模型在测试中 `id` 和 `created_at` 为 `None`
**原因**: SQLAlchemy 的默认值在实例化时不会自动生成
**解决**: 在测试中显式设置这些值，或使用 `side_effect` 捕获 `add()` 调用后赋值

```python
def capture_add(user):
    user.id = uuid.uuid4()
    user.created_at = datetime.now(timezone.utc)

mock_db.add = MagicMock(side_effect=capture_add)
```

#### 问题 3: passlib 对无效哈希的行为
**现象**: 期望 `verify_password` 对无效哈希返回 `False`，但实际抛出异常
**原因**: passlib 对无法识别的哈希格式会抛出 `UnknownHashError`
**解决**: 修改测试预期，验证异常抛出而非返回 `False`

```python
from passlib.exc import UnknownHashError

with pytest.raises(UnknownHashError):
    verify_password(password, invalid_hash)
```

### 技术决策

#### 决策 1: 使用 Mock 而非真实数据库
**原因**: 
- 提高测试速度
- 避免测试数据污染
- 更可控的测试场景

#### 决策 2: 测试类和被测试模块一一对应
**结构**:
- `TestPasswordSecurity` → `core/security.py`
- `TestAuthEndpoints` → `api/v1/endpoints/auth.py`
- `TestAuthDependencies` → `api/deps.py`

#### 决策 3: 每个测试只验证一个概念
例如 `test_login` 系列：
- `test_login_success` - 成功路径
- `test_login_wrong_password` - 密码错误
- `test_login_user_not_found` - 用户不存在
- `test_login_inactive_user` - 用户被禁用

### 覆盖率分析

```
Name                                           Stmts   Miss  Cover
-----------------------------------------------------------------
src/ai_ppt/api/deps.py                            31      0   100%
src/ai_ppt/api/v1/endpoints/auth.py               66      1    98%
src/ai_ppt/api/v1/schemas/auth.py                 36      0   100%
src/ai_ppt/config.py                              35      0   100%
src/ai_ppt/core/security.py                       43      5    88%
src/ai_ppt/models/user.py                         18      0   100%
-----------------------------------------------------------------
TOTAL 认证相关模块                               229      6    97%
```

**未覆盖代码说明**:
- `security.py:125` - `decode_token` 的通用异常处理分支
- `auth.py:282` - `get_me` 端点的成功响应（被其他测试间接覆盖）

### 经验教训

1. **Mock 技巧**: `AsyncMock` 对异步方法，`MagicMock` 对同步方法，`side_effect` 对需要拦截调用的场景

2. **边界测试**: 不仅要测试 "Happy Path"，还要测试：
   - 空值/None
   - 过期数据
   - 权限不足
   - 数据不存在

3. **环境隔离**: 使用 `JWT_SECRET_KEY=test-...` 环境变量确保测试使用固定密钥

4. **异步测试**: 记得使用 `@pytest.mark.asyncio` 装饰器

### 对项目的建议

1. **测试基类**: 创建 `BaseTestCase` 封装通用的 Mock 设置

2. **工厂模式**: 使用 `factory-boy` 生成测试数据：
   ```python
   class UserFactory(factory.Factory):
       class Meta:
           model = User
       email = factory.Faker('email')
       username = factory.Faker('user_name')
   ```

3. **持续集成**: 在 CI 中运行 `pytest --cov-fail-under=80`

4. **集成测试**: 在单元测试基础上，增加使用真实数据库的集成测试

### 后续计划

| 优先级 | 模块 | 预计用例数 |
|-------|------|----------|
| P1 | connector_service | 20 |
| P1 | outline_service | 25 |
| P2 | presentation_service | 30 |
| P2 | export_service | 20 |

目标：整体覆盖率达到 **80%**

### 参考资料

- [FastAPI Testing Guide](https://fastapi.tiangolo.com/tutorial/testing/)
- [pytest-asyncio Documentation](https://pytest-asyncio.readthedocs.io/)
- [unittest.mock — Python Documentation](https://docs.python.org/3/library/unittest.mock.html)
