## 开发心得 - FE-002: E2E 测试框架搭建

### 任务信息
- **任务编号**: FE-002
- **任务描述**: 安装 Playwright，编写核心流程 E2E 测试
- **耗时**: 2 小时
- **代码变更**: +150 行

### 完成的任务

1. ✅ Playwright 安装和配置
2. ✅ 编写 3 个测试文件
3. ✅ 配置测试环境

### Playwright 配置

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

### 编写的测试

#### 1. 基础导航测试 (`e2e/navigation.spec.ts`)
```typescript
test.describe('Basic Navigation', () => {
  test('should load home page', async ({ page }) => {
    await page.goto('/');
    await expect(page).toHaveTitle(/.*/);
    const main = page.locator('main');
    await expect(main).toBeVisible();
  });

  test('should navigate to login page', async ({ page }) => {
    await page.goto('/login');
    await expect(page.locator('form')).toBeVisible();
    await expect(page.getByRole('button', { name: /登录|Sign In/i })).toBeVisible();
  });
});
```

#### 2. 用户认证测试 (`e2e/auth.spec.ts`)
- 登录表单显示测试
- 表单验证测试
- 无效凭证错误提示测试
- 有效凭证登录测试
- 注册页面导航测试

#### 3. 大纲管理测试 (`e2e/outline.spec.ts`)
- 大纲列表页面导航
- 手动创建大纲
- AI 生成大纲
- 查看大纲详情
- 编辑现有大纲

### 遇到的问题

#### 问题 1: Playwright 浏览器安装
- **现象**: `npx playwright install` 需要下载浏览器二进制文件
- **解决**: 仅安装 Chromium 以节省空间: `npx playwright install chromium`
- **耗时**: 10 分钟

#### 问题 2: 测试需要后端服务
- **现象**: 登录和 outline 测试需要后端 API 支持
- **解决**: 
  - 基础导航测试独立运行
  - 其他测试使用 `test.skip()` 作为占位符
  - 添加测试账号 `test@example.com` / `password123`
- **耗时**: 20 分钟

### 技术决策

**决策**: 使用 Page Object Model (POM) 模式
**原因**:
- 提高测试可维护性
- 分离页面操作和测试逻辑
- 便于复用代码

**决策**: 使用 data-testid 属性定位元素
**原因**:
- 比 CSS 选择器更稳定
- 不受样式变化影响
- 明确标识测试用元素

```typescript
// 示例
await page.locator('[data-testid="outline-item"]').first().click();
```

### 测试执行

```bash
# 运行所有测试
npx playwright test

# 运行特定测试文件
npx playwright test e2e/auth.spec.ts

#  headed 模式查看执行过程
npx playwright test --headed

# 生成报告
npx playwright show-report
```

### 最佳实践总结

1. **测试隔离**: 每个测试用例独立运行，不依赖其他测试状态
2. **显式等待**: 使用 `expect().toBeVisible()` 而非固定等待时间
3. **语义化定位**: 优先使用 `getByRole`, `getByLabel` 而非 CSS 选择器
4. **错误截图**: 配置 `screenshot: 'only-on-failure'` 失败时自动截图

### CI/CD 集成建议

```yaml
# .github/workflows/e2e.yml
- name: Run Playwright tests
  run: |
    npx playwright install --with-deps
    npx playwright test
  env:
    BASE_URL: ${{ env.TEST_URL }}
```

### 后续优化方向

1. 添加 API mocking 支持，减少对后端的依赖
2. 实现 Page Object Model 类
3. 添加更多视觉回归测试
4. 配置并行测试执行
5. 添加移动端视口测试

### 参考资料
- https://playwright.dev/docs/intro
- https://playwright.dev/docs/best-practices
- https://playwright.dev/docs/pom
